
---
FrSmart 수정해야하는 부분

    def _convert_personality_to_mbti(self, v):

        # 이미 'INTP' 같은 문자열이면 그대로

        if isinstance(v, str) and len(v) == 4:

            return v.upper()

        # (레거시 숫자 대응: 필요 시 확장)

        legacy = {0:'NONE', 1:'ENFP', 2:'INFP', 3:'ISFP', 4:'ISTJ', 5:'ISFJ'}

        try:

            return legacy.get(int(v), 'NONE')

        except Exception:

            return 'NONE'



# Find Exp

    def setUiFindExpDlg(self, number):

        # 배경 이미지 설정 (그대로)

        self.ui_find_exp_dlg.label_background.setStyleSheet(

            dsImage.dsFindDetailImg[number])

  

        # ✅ URL 파라미터 구성

        try:

            # MBTI 문자열로 변환(선택 personality → MBTI)

            # 1) 변환 (여기서 바로 찍어두면 안전)

            mbti_str = self._convert_personality_to_mbti(getattr(self, 'find_per_range_num', 0))

            print(f"[QR] mbti_str(before params) = {mbti_str!r}")

  

            # 선택값 수집: (없으면 0으로)

            def nz(x):

                return int(x) if isinstance(x, (int, float)) else int(x) if str(x).isdigit() else 0

  

            # 2) params 조립: mbti는 4글자일 때만 키 추가

            params = {

                "perfume": number,

                "gender_id": nz(getattr(self, 'find_gender_range_num', 0)),

                "age_id": nz(getattr(self, 'find_age_range_num', 0)),

                "fashion_id": nz(getattr(self, 'find_fashion_range_num', 0)),

                "pref_color_id": nz(getattr(self, 'find_color_range_num', 0)),

                "purpose_id": nz(getattr(self, 'find_purpose_range_num', 0)),

                "top": 30, "middle": 40, "base": 30,

                "lang": "en",

            }

            # 4글자 MBTI일 때만 넣기 (대문자 보정)

            if isinstance(mbti_str, str) and len(mbti_str) == 4:

                params["mbti"] = mbti_str.upper()

  

            print(f"[QR] params(before clean) = {params}")  # ← 디버그

  

            qr_path = dsQRcode.generate_qr_code(

                save_path=f"temp_qr_{number}.png",

                base_url="https://perfume-mobile.vercel.app/result",

                params=params,

            )

  

            # if isinstance(mbti_str, str) and len(mbti_str) == 4:

            #     params["mbti"] = mbti_str  # ← 빈문자 안 씀

            #     # ✅ QR 생성 (모바일 결과 URL로 고정)

            #     qr_path = dsQRcode.generate_qr_code(

            #         save_path=f"temp_qr_{number}.png",

            #         base_url="https://perfume-mobile.vercel.app/result",

            #         params=params,

            #     )

  

            # QR 라벨 배치 (기존 코드 유지)

            if not hasattr(self, 'qr_label'):

                self.qr_label = QtWidgets.QLabel(self.ui_find_exp_dlg)

                self.qr_label.setFixedSize(100, 100)

                self.qr_label.setStyleSheet("border: none; background: transparent;")

  

            qr_pixmap = QtGui.QPixmap(qr_path)

            self.qr_label.setPixmap(qr_pixmap.scaled(100, 100, Qt.AspectRatioMode.KeepAspectRatio))

            self.qr_label.move(self.ui_find_exp_dlg.width() - 120, 20)

            self.qr_label.show()

  

        except Exception as e:

            print(f"QR 코드 생성 오류: {e}")

            if hasattr(self, 'qr_label'):

                self.qr_label.hide()
                
                