

---

## 실질적인 제어 명령 함수 위치 및 역할

## 1. 주요 제어 명령 함수들 (PC 쪽 코드 내)

- **`WriteSingleReg_MFC(unsigned short add, unsigned short value)`**
    
    - 단일 홀딩 레지스터에 값을 쓰는 MODBUS 요청을 만들어 펌웨어로 전송.
        
    - 예) 특정 펌프 전력, 밸브 상태 등 1개 파라미터 제어.
        
- **`WriteMultiReg_MFC(unsigned short add, unsigned short cmdvalue)`**
    
    - 여러 홀딩 레지스터를 한 번에 쓰는 MODBUS 요청 생성 및 전송.
        
    - 예) 여러 밸브의 duty 값 일괄 제어.
        
- **`SetDutyBoard_MFC(int sbdindex)`**
    
    - 솔레노이드 보드별로 6개 포트에 대해 duty 값을 계산 후, `WriteMultiReg_MFC`를 통해 그룹 단위로 명령 송신.
        
    - 즉, 밸브의 개별 동작 출력을 실제로 제어하는 핵심 함수.
        
- 이들 함수는 **`SendToCom()`** 을 호출하여, MODBUS 명령 패킷을 OS 시리얼 드라이버를 거쳐 펌웨어로 전송함.
    

## 2. 명령 패킷 생성 및 전송 과정

- 함수 안에서 MODBUS 프로토콜에 맞게
    
    - 장치 ID,
        
    - 함수 코드 (예: 0x06 = Write Single Register, 0x10 = Write Multiple Registers),
        
    - 시작 주소,
        
    - 데이터,
        
    - CRC 등을 포함한 패킷을 만든 후,
        
- `SendToCom()` 호출로 시리얼 포트에 데이터를 실제 출력.
    

---

## 펌웨어 쪽 처리 개념

- 펌웨어는 UART 또는 물리적 시리얼 인터페이스를 통해 이 명령 패킷을 수신.
    
- 내부의 MODBUS 프로토콜 스택이 패킷을 해석해,
    
- 명령에 따라 펌프, 밸브 등 실제 하드웨어를 제어.
    

---

## 요약

|함수명|역할|비고|
|---|---|---|
|WriteSingleReg_MFC|홀딩 레지스터 1개 쓰기 명령 생성 및 전송|단일 값 제어용|
|WriteMultiReg_MFC|홀딩 레지스터 여러 개 쓰기 명령 생성 및 전송|다중 값 동시 제어용|
|SetDutyBoard_MFC|특정 솔레노이드 보드 6채널 duty 계산 후 전송|밸브 개별 제어의 핵심 함수|
|SendToCom|MODBUS 패킷 시리얼 포트로 송신|OS 시리얼 드라이버와 하드웨어 사이|

---

즉, **실질적인 제어 명령은 `WriteSingleReg_MFC`, `WriteMultiReg_MFC`, `SetDutyBoard_MFC` 같은 함수에서 내리고, 그 명령 전송을 `SendToCom`이 수행합니다.**

`DecodePacket`이나 `DecodeData_MFC` 함수는 펌웨어에서 받은 **응답 처리/해석**만 담당하며, 제어 명령을 내리지는 않습니다.

---
