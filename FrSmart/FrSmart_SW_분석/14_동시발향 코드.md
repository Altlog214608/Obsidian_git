좋습니다 👍 올려주신 **FrSmart.py**와 **dsComm.py**를 기준으로 “동시발향” 기능을 정리해드릴게요.  
핵심은 **여러 향수 밸브를 동시에 열어서 원하는 비율(duty percent)로 분사**하는 과정입니다.

---

# 🔹 동시발향( Simultaneous Scent Control ) 총정리

## 1. 개념

- 장치에는 여러 개의 **밸브(최대 12개)**가 있고, 각각이 하나의 향수 슬롯을 담당.
    
- 일반 발향은 **특정 번호 하나만 선택**해서 분사.
    
- **동시발향**은 여러 밸브를 동시에 일정 비율(듀티 값)로 열어 **믹스된 향**을 발생시킴.
    

---

## 2. 주요 함수 흐름

### (1) `pb_mix_test()`

- 사용자가 믹싱 페이지에서 “테스트 버튼”을 누를 때 호출.
    
- 슬라이더에서 설정한 값들을 읽어와 `scent_config` 딕셔너리 구성:
    

```python
scent_config = { 1: 40, 3: 60 }   # 예: 1번 향수 40%, 3번 향수 60%
```

- 이 `scent_config`를 `progressBarMixScentAndClean()`에 전달.
    

---

### (2) `progressBarMixScentAndClean(scent_config, progress_bar)`

- 프로그레스바를 돌리면서 실제 발향 명령 전송.
    
- 내부에서 **`requestSimultaneousScentControl(scent_config)`** 호출 → 동시발향 핵심 실행.
    

---

### (3) `requestSimultaneousScentControl(scent_config)`

1. **펌프 파워 설정 전송**
    
    ```python
    sendMsg_power = dsComm.sendMsgForPumpPower_C(id=1, run_power, clean_power)
    ```
    
    → 발향펌프와 세정펌프 출력 세기 설정.
    
2. **펌프 시간 설정 전송**
    
    ```python
    sendMsg_time = dsComm.sendMsgForPumpTime_C(id=1, run_time, clean_time)
    ```
    
    → 발향 지속 시간과 세정 시간 지정.
    
3. **밸브 듀티 설정 (여러 개 동시에)**
    
    - `scent_config`를 순회하면서 각 향수 번호에 해당하는 보드/포트 위치 계산.
        
    - 보드 단위로 duty 배열 생성 후,
        
        ```python
        sendMsg_valve = dsComm.sendMsgForValveDuty_C(id=1, board_index, valve_duties)
        ```
        
        호출하여 보드별 밸브 개방 비율 설정.
        
4. **명령 실행 (Run & Clean)**
    
    ```python
    sendMsg_cmd = dsComm.sendMsgForCommand_C(id=1, command=4)  # CMD_RUNCL = 4
    ```
    
    → “발향 + 세정”을 동시에 실행하는 최종 명령.
    

---

## 3. 하위 메시지 생성 (dsComm.py)

- `sendMsgForPumpPower_C()` → 펌프 출력 세기 패킷 생성.
    
- `sendMsgForPumpTime_C()` → 발향/세정 시간 패킷 생성.
    
- `sendMsgForValveDuty_C()`
    
    - 각 밸브의 duty 값을 **5차식 보정 계산** 후 장치 제어 값으로 변환.
        
    - duty=0이면 닫고, >0이면 지정 비율만큼 개방.
        
- `sendMsgForCommand_C()` → 최종 실행 명령 패킷 생성.
    

모든 메시지는 **Modbus CRC16**으로 검증 후 시리얼로 전송됨.

---

## 4. 동작 순서 요약 (쉽게)

1. UI 슬라이더에서 비율 설정 (예: 1번 40%, 3번 60%).
    
2. `pb_mix_test()` → `progressBarMixScentAndClean()` → `requestSimultaneousScentControl()`.
    
3. 내부에서 차례로:
    
    - 펌프 세기 설정
        
    - 펌프 시간 설정
        
    - 밸브별 듀티 설정 (동시에 여러 개 열림)
        
    - 실행 명령 전송
        
4. 지정된 시간 동안 여러 향수가 동시에 분사.
    
5. 끝나면 세정 과정 실행.
    

---

✅ 이렇게 정리하면, “동시발향”은 **UI → 슬라이더 값 수집 → 프로토콜 메시지 조립 → 펌프+밸브 제어 → 실행 명령**의 흐름으로 작동합니다.

---

원하시나요? 제가 **실제 시리얼로 전송되는 패킷 예시(hex)**도 같이 정리해드릴까요?