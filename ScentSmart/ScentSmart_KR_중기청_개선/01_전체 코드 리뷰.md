
# 1) 한눈에 보는 구조(mental model)

- **메인 컨트롤러 클래스:** `UiDlg(QWidget)` 한 개가 전체 앱을 통합 관리합니다. 시작 시 시리얼 스레드 연결 → 설정 로드 → 키입력 필터 구성, 이후 여러 “다이얼로그(화면)”를 로딩하고 화면 전환을 담당합니다.
    
- **주요 서브시스템**
    
    - **UI 로더:** Qt Designer로 만든 `.ui` 파일들을 `QUiLoader`로 읽어 위젯을 구성(메인, 로그인, 피검자 관리, 메뉴, 각 검사/재활 화면 등). 또한 커스텀 차트/슬라이더 위젯 등록.
        
    - **시리얼 통신:** `dsSerial` 스레드가 수신 → 시그널로 `UiDlg.readSerialData()`에 전달 → 콘솔 출력 + 파싱 → 로직. 송신은 `write_data()`로 처리.
        
    - **프로토콜/메시지:** `dsComm` 모듈을 통해 MODBUS 스타일 레지스터 읽기/쓰기 메시지를 만들어 장치에 전송(발향/세정/중지/온도/압력 요청 등).
        
    - **검사·재활 상태:** `dsTest`, `dsTestTH/DC/ID` 모듈이 현재 검사 타입과 경과 시간을 들고 있고, QTimer가 초마다 카운트 → 화면의 시간 레이블을 갱신.
        
    - **DB:** `dsTestDB`로 피검자와 검사결과 테이블을 생성/조회합니다.
        

# 2) UI 흐름(화면 구성과 전환)

- **초기화:** `uiDlgInit()`에서 모든 화면을 로드하고 시그널을 연결합니다(메인, 로그인, 피검자, 메뉴, 인지검사, 재활, 메시지, 설정, 프로토콜, 타이머, DB). 이때 커스텀 위젯(라인/파이 차트와 슬라이더)도 등록합니다.
    
- **메인 화면 → 로그인:** 메인에서 로그인 버튼을 누르면 비밀번호 확인 후 피검자 정보 화면으로 넘어갑니다. (도움말/종료 버튼도 존재)
    
- **피검자(Subject) 관리:** 이름/생년/성별을 입력/선택하고 다음으로 넘어갑니다. 선택된 피검자 정보는 이후 모든 화면 상단에 표시됩니다.
    
- **메뉴:** 검사(역치/식별/인지)와 결과, 설정, 재활(훈련 ST/ID) 등 각 기능으로 이동하는 허브입니다. 현재는 인지검사와 재활(ID) 중심으로 보이도록 토글되어 있습니다.
    
- **결과/알림/확인 다이얼로그들:** 저장/평가/확인용 팝업이 준비되어 있고, 통일된 메시지 다이얼로그로 사용자에게 텍스트 안내를 띄웁니다.
    

# 3) 시리얼 통신과 프로토콜(발향·세정·센서)

- **수신 파이프라인:** 시리얼 스레드(최우선 순위)가 바이트를 받으면 → `serialReceivedData` 시그널 → `readSerialData()`가 콘솔에 `RX(len):hex` 형태로 찍고 → `parseReadData()`에서 헤더(장치ID, 기능코드, 주소)를 언팩해 확인합니다.
    
- **송신 파이프라인:** `write_data()`는 연결 여부 확인 후 바이트를 쓰고, `TX(len):hex`를 콘솔에 남깁니다. 미연결 시 텍스트 안내.
    
- **주요 요청 메서드**
    
    - `requestScentNo(scent_no, command)`: 발향/세정을 한 프레임으로 묶어 보냅니다(기본 파워·시간·딜레이는 설정값에서 읽음). 주소는 `ADDRESS_RUN_CLEAR`, func=16(멀티레지스터 쓰기).
        
    - `requestScentNoAndTime(..., scent_run_time)`: 위와 동일하되 발향 시간만 인자로 덮어쓰기.
        
    - `requestScentWithValues(...)`: 파워/시간/딜레이를 모두 직접 지정해 전송. 세부 튜닝/디버깅에 사용.
        
    - `pushButton_stop_clicked()`: 즉시 중지(단일 레지스터 쓰기, func=6).
        
    - `requestTempPress() / temperature/pressure`: 레지스터 읽기(func=4)로 온도/압력 데이터를 요청. (각 주소/개수 지정)
        
- **프로토콜 테스트 화면:** 포트/보드레이트/패리티 등 UI에서 선택 → 연결/발향/세정/정지/센서 읽기 버튼으로 즉시 명령을 보낼 수 있습니다. 시리얼 콘솔(TextEdit)에 RX/TX 로그가 실시간 출력됩니다.
    

# 4) 검사·재활 로직(시간 흐름과 진행바)

- **검사 타입과 시간 카운트:** `dsTest.test_type`으로 현재 모드를 구분(1:역치, 2:식별, 3:인지). QTimer가 1초마다 해당 모듈의 카운트 변수를 증가시키고, 각 검사 화면의 타임 레이블을 `hh:mm:ss`로 갱신합니다.
    
- **진행바(발향→세정):** `progressBarScentAndClean()`은 먼저 장치에 발향/세정 통합 명령을 보낸 뒤, 발향 시간 동안 1~~100%로 진행바를 채우고, 레이블/스타일 변경 후 세정 시간 동안 다시 1~~100% 진행합니다. 끝나면 발향 간격(emit interval)만큼 대기. 훈련(ST/ID)용 별도 변형도 있습니다.
    

# 5) 설정, 포트 검색, DB, 타이머

- **설정 화면:** 슬라이더/스핀박스로 발향 파워·시간, 세정 파워·시간, 발향 간격 등 파라미터를 조절하면 내부 설정(`dsSetting.dsParam`)과 UI 동기화. 포트 목록 새로고침/연결 토글/상태 라벨 업데이트까지 포함됩니다.
    
- **포트 검색/자동 연결:** 사용 가능한 포트를 스캔하여 콤보박스에 채우고, 첫 번째 포트로 기본 연결을 시도합니다. 연결 상태에 따라 버튼/라벨 문구도 바뀝니다.
    
- **DB 초기화:** 시작 시 피검자/인지검사 결과 테이블을 생성(없으면)하여 이후 조회/저장에 대비.
    
- **타이머:** 1초 간격 `QTimer` 구동 → 검사 타입에 맞는 시간 카운트 증가 → 해당 화면의 타임 레이블 업데이트.
    

# 6) 로그인과 보안(PW)

- 로그인 비밀번호는 암호화(`dsCrypto`)되어 파일(`dsAP`)에 저장/로드됩니다. 기본 비번 허용, 시도 횟수 카운트(오류 누적 시 경고) 등도 포함. (관련 로직은 로그인 다이얼로그 전환과 함께 동작)
    

# 7) 자주 묻는 포인트 요약

- **“발향/세정 한 프레임”이 뭔가요?** → 장치에 한번에 “무슨 향(채널), 얼마나 세게, 몇 초 동안, 그 다음 세정은 몇 초 동안” 같은 파라미터 묶음을 func=16으로 쓰는 패킷입니다. 빠르게 이어지는 발향-세정 사이클을 장치가 자율 수행하게 합니다.
    
- **진행바는 실제 시간과 동기화되나요?** → 네. 설정된 시간(초)을 기반으로 `QTest.qWait`로 진행바를 채워, 장치 동작과 UI 체감이 맞도록 설계했습니다.
    
- **센서(온도/압력) 읽기는?** → 읽기 함수(func=4)로 특정 주소 범위를 요청하고, 수신은 `parseReadData()`에서 공통 헤더를 먼저 확인한 뒤 후속 파싱을 확장하게 되어 있습니다(현재는 ID/기능/주소까지 파싱).
    

# 8) 확장 방법(실무 팁)

1. **새로운 ‘훈련 시나리오’ 추가**
    
    - `ui_train_id_select`에 새 버튼 연결 → `startTrainIDScenes(dsTrainID.id_train_scene_X)`로 시작 → 필요 시 `ui_train_id_scene_choice_N`(선택지 개수에 맞는 UI) 중 하나와 진행바 함수를 조합.
        
2. **발향 파라미터를 테스트 화면에서 즉시 바꿔 보기**
    
    - 프로토콜 창에서 `requestScentWithValues(...)`를 호출하는 버튼(`emit/clean/emit+clean`)을 사용하면 설정값에 구애받지 않고 즉시 실험 가능.
        
3. **센서 응답 상세 파싱 추가**
    
    - `parseReadData()`의 언팩을 확장해 바디(데이터 필드)에서 온도/압력의 실제 값 변환까지 구현. 현재 헤더까지만 파싱하며, 여기서 레지스터 값 스케일링(예: 0.1℃ 단위) 로직을 덧붙이면 됩니다.
        

---

필요하면, 특정 함수(예: `uiDlgSubject` 테이블 로딩/선택 로직, 로그인 PW 변경 흐름, 포트 재연결 처리 등)를 콕 집어 **실행 순서도**로 풀어드릴게요. 어느 부분부터 더 깊게 파볼까요?